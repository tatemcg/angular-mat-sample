<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
      <title>JSON to graphics layer</title>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
      <link rel="stylesheet" href="https://js.arcgis.com/4.9/esri/css/main.css">
      <link rel="stylesheet" href="css/style.css">

      <script src="https://js.arcgis.com/4.9/"></script>
      <!-- <script src="js/main.js"></script> -->
	  <style>
			html, body, #viewDiv {
			background-color: #2a2a28;
			padding: 0;
			margin: 0;
			height: 100%;
			width: 100%;
			}
			#police {
			position: fixed;
			z-index:30;
			right:30px;
			top:30px;
			}
			.button{
			color: gray;
			background-color: white;
			border-width: 0;
			font-family: 'Times New Roman', Times, serif;
			font-size: 1.2em;
			width: 175px;
			}

	  </style>
	  
		<script>
			require([
			"esri/Map",
			"esri/views/MapView",
			"esri/Graphic",
			"esri/geometry/support/webMercatorUtils",
			"esri/layers/FeatureLayer",
			"esri/layers/GraphicsLayer",
			"esri/widgets/Search",
			"dojo/domReady!"
			], function (
				Map, MapView, Graphic, webMercatorUtils, FeatureLayer, GraphicsLayer, Search
			) {

				var map = new Map({
					basemap: "dark-gray-vector"
				});

				var view = new MapView({
					center: [-0.4435809, 51.7512485],
					container: "viewDiv",
					map: map,
					zoom: 13
				});

				// Adding the crime graphics layer to the map.
				var crimeLayer = new GraphicsLayer();
				map.add(crimeLayer)

				// bl = bottomLeft, br = bottomRight, tl = topLeft and tr = topRight
				var bl, br, tl, tr;
				var loadedNumber = 0;

				//add as many dates as you like in the array below...
				var crimeDates = ["2018-10","2018-11","2018-12","2019-01","2019-02", "2019-03", "2019-04"]

				//click listener
				document.getElementById("police").addEventListener("click", police)


				function police() {
					reset();

					loadedNumber = 0;

					for (dates = 0; dates < crimeDates.length; dates++) {
						policeData(crimeDates[dates])
					}
				}

				//converts x y to long latt
				function convertxy(x, y) {
					return webMercatorUtils.xyToLngLat(x, y)
				}

				function getExtent() {
					bl = convertxy(view.extent.xmin, view.extent.ymin)
					br = convertxy(view.extent.xmax, view.extent.ymin)
					tl = convertxy(view.extent.xmin, view.extent.ymax)
					tr = convertxy(view.extent.xmax, view.extent.ymax)
				}

				function policeData(date) {
					getExtent();

					// This is the current view extent
					var currentExtent = bl[1] + "," + bl[0] + ":" + br[1] + "," + br[0] + ":" + tr[1] + "," + tr[0] + ":" + tl[1] + "," + tl[0]
					$.ajax({
						url: "https://data.police.uk/api/crimes-street/all-crime?",
						type: "GET",
						data: {
							'f': 'pjson',
							'poly': currentExtent,
							'date': date
						}
					}).done(function (data) {

						//Use all returning data to add points to a map.
						createPointsOnMap(data)

						/*  
						category: "criminal-damage-arson",
						id: 68146477,
						location: {
							latitude: "51.746759"
							longitude: "-0.427947"
						},
						street: {id: 793286, name: "On or near Clayton Drive"},
						location_type: "Force"
						*/

					});
				}

				function createPointsOnMap(data) 
				{
					for (i = 0; i < data.length; i++) 
					{
						var policePoints = new Graphic({
							geometry: {
								type: "point", // autocasts as new Point()
								longitude: data[i].location.longitude,
								latitude: data[i].location.latitude
							},
							symbol: {
								type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
								color: [88, 57, 193, 0.1],
								size: 20,
								outline: { // autocasts as new SimpleLineSymbol()
									width: 0
								}
							},
							attributes: {
								Category: data[i].category,
								Street: data[i].location.street.name,
								Month: data[i].month
							},
							popupTemplate: { // autocasts as new PopupTemplate()
								title: "{Category}",
								content: [{
									type: "fields",
									fieldInfos: [{
										fieldName: "Street"
									}, {
										fieldName: "Month"
									}]
								}]
							}
						});

						crimeLayer.add(policePoints)
					}
				}

				function reset() {
					crimeLayer.removeAll()
				}

				//Adding search widget
				var searchWidget = new Search({
					view: view
				});

				// Add the search widget to the bottom left corner of the view
				view.ui.add(searchWidget, {
					position: "bottom-left"
				});

			});
      </script>
   </head>
   <body>
      <div id="police"><button class="button" id="police">crime points</button></div>
      <div id="viewDiv"></div>
   </body>
</html>