<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Puerto Rico - Recovery Map</title>
<style>
  html, body, #viewDiv {
    padding: 0;
    margin: 0;
    height: 95%;
    width: 100%;
  }
  #headerDiv {
    background-color: green;
  }
</style>
<link rel="stylesheet" href="https://js.arcgis.com/4.7/esri/css/main.css">
<script src="https://js.arcgis.com/4.7/"></script>
<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/widgets/Legend",
   "esri/renderers/UniqueValueRenderer",
   "esri/symbols/SimpleLineSymbol",
  "dojo/domReady!"
], function(Map, MapView, FeatureLayer, Legend, UniqueValueRenderer, SimpleLineSymbol) {
	var leastNum = -99;
	var wordLegend = "No Application";
	var layerURL = "https://uatgis.recovery.pr/webgisdev/rest/services/TP_Financial_Muni_Dev/MapServer/3";
   var defaultSym = {
        type: "simple-fill", // autocasts as new SimpleFillSymbol()
        outline: { // autocasts as new SimpleLineSymbol()
          color: "#000000",
          width: 1
        }
    };
  
	var renderer = {
        type: "simple", // autocasts as new SimpleRenderer()
        symbol: defaultSym,
        label: "Population",
        visualVariables: [{
          type: "color",
          field: "obligated_amt",
          stops: [
          {
            value: leastNum,
            color: "#ffffff",
            label: wordLegend
          },
		  {
            value: 0,
            color: "#8F97E3",
            label: "0"
          },
          {  
            value: 3042611.63,
            color: "#003994",
            label: "41,000,000"
          }]
        }]
    };


	const counties_feature_layer = new FeatureLayer({
		//url: "https://services.arcgis.com/85ZqtFFgqCh5li9K/ArcGIS/rest/services/municipal_boundary4/FeatureServer/0",
		url: layerURL,
		renderer: renderer,
        outFields: ["*"],
		//opacity: .7,
		labelsVisible: true,
        popupTemplate: { // autocasts as new PopupTemplate()
          title: "{municipality_name_esp}",
          content: "{municipality_name_esp} has approximately {obligated_amt} people and approximately {Total_Households_Estimate} households.",
          fieldInfos: [
          {
            fieldName: "MUNICIPIO",
            format: {
              digitSeparator: true,
              places: 0
            }
          }, {
            fieldName: "Population",
            format: {
              digitSeparator: true,
              places: 0
            }
          }]
        }
      });
  
	var map = new Map({
		//basemap: "hybrid",
		layers: [counties_feature_layer]
	});
  

  
  var view = new MapView({
		container: "viewDiv",  // Reference to the scene div created in step 5
		map: map,  // Reference to the map object created before the scene
		center: [-66.519, 18.230],
		zoom: 9
	});
	
	function changeCursor(response) {
		if (response.results.length > 0) {
			document.getElementById("viewDiv").style.cursor = "pointer";
		} else {
			document.getElementById("viewDiv").style.cursor = "default";
		}
	}
	
	
	function getGraphics(response) {
		view.graphics.removeAll();
		if (response.results.length > 0) {
			var graphic = response.results[0].graphic;
			graphic.symbol = 
			{
				type: "simple-fill",
				style: "solid",
				color: [ 17, 114, 212, 0.5 ],
				outline: 
				{ // autocasts as new SimpleLineSymbol()
				  color: "white",
				  width: 1
				}
			}
			view.graphics.add(graphic);
		}
	}
		
 
	
	view.when(function() {
          // get the first layer in the collection of operational layers in the WebMap
          // when the resources in the MapView have loaded.
          var featureLayer = counties_feature_layer;

          var legend = new Legend({
            view: view,
            layerInfos: [{
              layer: featureLayer,
              title: "County Sizes in Puerto Rico"
            }]
          });
		view.whenLayerView(featureLayer).then(function (lview) 
		{
			watchUtils.whenFalseOnce(lview, "updating", function () {
            // Set up a click event handler and retrieve the screen x, y coordinates
            view.on("pointer-move", function (evt) 
			{
              var screenPoint = {
                x: evt.x,
                y: evt.y
              };

              // the hitTest() checks to see if any graphics in the view
              // intersect the given screen x, y coordinates
              view.hitTest(screenPoint)
                .then(function (response) 
				{
					if(response.results.length)
					{
					  var graphic = response.results.filter(dataResult =>
					  {
						   return dataResult.graphic.layer === featureLayer;
					  })[0].graphic;
					  //const attributes = graphic.attributes;
					  //var FIPS = attributes.municipality_fips_code;
					  //console.log("FIPS CODE: "+FIPS);
					  //document.getElementById("TotalPopData").innerHTML = "Total Population "+
					  //attributes.municipality_name +" is: "+ attributes.municipality_2010_population;
					}
                  changeCursor(response);
                  getGraphics(response);
                });
            });
          });
        });  

          // Add widget to the bottom right corner of the view
          view.ui.add(legend, "top-right");
    });  
	  
});
</script>
<body background-color:"#000000">
<!--   <div id="headerDiv" >
  <img src="logop3-gpr-white.png"/>
  </div> -->
  <div id="viewDiv"></div>
</body>
</head>
</html>